<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Premium Expense Tracker</title>
  <link rel="stylesheet" href="premiumexpense.css" />
</head>
<body>
  <div id="expense-container">
    <h1>Expense Tracker</h1>
<div id="debug-token" style="background:#222;color:#0f0;padding:10px;margin-bottom:10px;word-wrap:break-word;">
      Loading token...
    </div>
    <!-- Top bar -->
    <div class="top-bar">
      <div class="right-controls">
        <div class="premium-badge">You are a Premium User </div>
        <button id="show-leaderboard-btn">Show Leaderboard</button>
        <button class="logout-btn" id="logout-btn">Logout</button>
      </div>
    </div>

    <!-- Add Expense -->
    <div class="card">
      <h3>Add Expense</h3>
      <form id="expense-form" class="expense-form-layout">
        <div class="expense-row">
          <input type="number" id="amount" class="form-input" placeholder="Amount" required />
          <input type="text" id="description" class="form-input" placeholder="Description" required />
          <select id="category" class="form-input" required>
            <option value="">Select Category</option>
            <option value="Food">Food</option>
            <option value="Petrol">Petrol</option>
            <option value="Salary">Salary</option>
            <option value="Others">Others</option>
          </select>
          <select id="type" class="form-input" required>
            <option value="">Select Type</option>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
          <input type="text" id="note" class="form-input" placeholder="Note (optional)" />
          <button type="submit" class="add-btn">Add Expense</button>
        </div>
      </form>
    </div>

    <div class="grid">
      <!-- Expense List -->
      <div class="card">
        <h3>Expense List</h3>
        <table>
          <thead>
            <tr>
              <th>Amount</th>
              <th>Description</th>
              <th>Category</th>
              <th>Type</th>
              <th>Note</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="expense-body"></tbody>
        </table>
      </div>

      <!-- Expense Reports -->
      <div class="card">
        <h3>Expense Reports</h3>
        <div class="report-buttons">
          <button class="btn-secondary" onclick="loadReport('daily')">Daily</button>
          <button class="btn-secondary" onclick="loadReport('weekly')">Weekly</button>
          <button class="btn-secondary" onclick="loadReport('monthly')">Monthly</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date/Period</th>
              <th>Total Income</th>
              <th>Total Expense</th>
            </tr>
          </thead>
          <tbody id="report-body"></tbody>
        </table>

        <button id="download-btn" class="download-btn" disabled>⬇ Download Report</button>

        <h3>Export History</h3>
        <table id="history-section" class="hidden">
          <thead>
            <tr>
              <th>#</th>
              <th>Generated At</th>
              <th>Download</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>

        <button id="toggle-history-btn">Show History</button>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="card hidden" id="leaderboard-section">
      <h3>Leaderboard</h3>
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>User</th>
            <th>Total Expense</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-controls">
      <label for="pageSizeSelect">Items per page:</label>
      <select id="pageSizeSelect">
        <option value="3">3</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="40">40</option>
      </select>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- ALL JS INLINE -->
  <script type="module">
  // ✅ API BASE URL
  const API_BASE_URL =
    window.location.hostname === "localhost"
      ? "http://localhost:3000"
      : "http://3.109.62.226"; // remove :3000 if nginx proxy is handling /api

    const token = localStorage.getItem("token");

  // ✅ Debug: show token on page and console
  if (token) {
    console.log("🔑 Token from localStorage:", token);
    document.getElementById("debug-token").innerText = "Token: " + token;
  } else {
    document.getElementById("debug-token").innerText = "❌ No token found, redirecting...";
    window.location.href = "login.html";
  }


  // ✅ DOM references
  const leaderboardBtn = document.getElementById("show-leaderboard-btn");
  const leaderboardSection = document.getElementById("leaderboard-section");
  const leaderboardBody = document.getElementById("leaderboard-body");
  const reportBody = document.getElementById("report-body");
  const downloadBtn = document.getElementById("download-btn");
  const pageSizeSelect = document.getElementById("pageSizeSelect");

  let currentPage = 1;

  async function loadExpenses(page = 1) {
    try {
      const pageSize = localStorage.getItem("pageSize") || 30;
      const res = await fetch(
        `${API_BASE_URL}/api/premiumexpenses?page=${page}&limit=${pageSize}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const data = await res.json();

      if (!res.ok || !data.expenses) {
        console.error("Error fetching expenses:", data);
        alert(data.message || "Failed to load expenses");
        return;
      }

      const tbody = document.getElementById("expense-body");
      tbody.innerHTML = "";

      data.expenses.forEach((exp) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${Number(exp.amount).toFixed(2)}</td>
          <td>${exp.description}</td>
          <td>${exp.category}</td>
          <td>${exp.type}</td>
          <td>${exp.note || ""}</td>
          <td><button onclick="deleteExpense(${exp.id})">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(data.pagination);
      currentPage = data.pagination.page;
    } catch (err) {
      console.error("Error loading expenses:", err);
    }
  }

  function renderPagination({ page, totalPages }) {
    const container = document.getElementById("pagination");
    container.innerHTML = "";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Prev";
    prevBtn.disabled = page === 1;
    prevBtn.addEventListener("click", () => loadExpenses(page - 1));
    container.appendChild(prevBtn);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === page) btn.disabled = true;
      btn.addEventListener("click", () => loadExpenses(i));
      container.appendChild(btn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Next";
    nextBtn.disabled = page === totalPages;
    nextBtn.addEventListener("click", () => loadExpenses(page + 1));
    container.appendChild(nextBtn);
  }

  document.getElementById("expense-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const amount = document.getElementById("amount").value.trim();
    const description = document.getElementById("description").value.trim();
    const category = document.getElementById("category").value;
    const type = document.getElementById("type").value;
    const note = document.getElementById("note").value.trim();

    try {
      const res = await fetch(`${API_BASE_URL}/api/premiumexpenses`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ amount, description, category, type, note }),
      });
      const data = await res.json();

      if (!res.ok) {
        console.error("Error adding expense:", data);
        alert(data.error || "Failed to add expense");
        return;
      }

      e.target.reset();
      loadExpenses(currentPage);
    } catch (err) {
      console.error("Error adding expense:", err);
    }
  });

  window.deleteExpense = async function (id) {
    if (!confirm("Are you sure you want to delete this expense?")) return;
    try {
      const res = await fetch(`${API_BASE_URL}/api/premiumexpenses/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (!res.ok) {
        console.error("Error deleting expense:", data);
        alert(data.error || "Failed to delete expense");
        return;
      }
      loadExpenses(currentPage);
    } catch (err) {
      console.error("Error deleting expense:", err);
    }
  };

      // ✅ Leaderboard
      leaderboardBtn.addEventListener("click", async () => {
  const isHidden = leaderboardSection.classList.contains("hidden");
  if (isHidden) {
    try {
      const res = await fetch(`${API_BASE_URL}/api/premiumexpenses/leaderboard`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Invalid leaderboard data");

      leaderboardBody.innerHTML = "";
      data.forEach((user, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${user.name}</td>
          <td>${user.total_expense ?? 0}</td>
        `;
        leaderboardBody.appendChild(tr);
      });

      leaderboardSection.classList.remove("hidden");
      leaderboardBtn.textContent = "Hide Leaderboard";
    } catch (err) {
      console.error("Error loading leaderboard:", err);
    }
  } else {
    leaderboardSection.classList.add("hidden");
    leaderboardBtn.textContent = "Show Leaderboard";
  }
});

// ✅ Reports
window.loadReport = async (period) => {
  try {
    const res = await fetch(
      `${API_BASE_URL}/api/premiumexpenses/report?period=${period}`,
      { headers: { Authorization: `Bearer ${token}` } }
    );
    const data = await res.json();
    if (!res.ok || !Array.isArray(data)) {
      console.error("Report error:", data);
      alert(data.error || "Failed to load report");
      return;
    }

    reportBody.innerHTML = "";
    data.forEach((row) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.period}</td>
        <td>${Number(row.total_income || row.totalIncome || 0).toFixed(2)}</td>
        <td>${Number(row.total_expense || row.totalExpense || 0).toFixed(2)}</td>
      `;
      reportBody.appendChild(tr);
    });

    downloadBtn.disabled = false;
    downloadBtn.dataset.period = period;
  } catch (err) {
    console.error("Error loading report:", err);
  }
};

// ✅ Download Report
downloadBtn.addEventListener("click", async () => {
  const period = downloadBtn.dataset.period || "monthly";
  try {
    const res = await fetch(
      `${API_BASE_URL}/api/premiumexpenses/download?period=${period}`,
      { headers: { Authorization: `Bearer ${token}` } }
    );
    if (!res.ok) throw new Error("Download failed");
    const data = await res.json();
    if (!data.fileUrl) throw new Error("No file URL returned");

    window.open(data.fileUrl, "_blank");
  } catch (err) {
    console.error("Error downloading:", err);
    alert("Download failed.");
  }
});

// ✅ Load Export History
async function loadExportHistory() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/premiumexpenses/history`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();

    const tbody = document.getElementById("history-body");
    tbody.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = "<td colspan='3'>No reports generated yet.</td>";
      tbody.appendChild(tr);
      return;
    }

    data.forEach((file, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${new Date(file.created_at).toLocaleString()}</td>
        <td><a href="${file.url}" target="_blank">⬇ Download</a></td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Error loading history:", err);
  }
}

window.loadExportHistory = loadExportHistory;


      // ✅ Pagination size
      const savedSize = localStorage.getItem("pageSize") || 10;
      pageSizeSelect.value = savedSize;
      pageSizeSelect.addEventListener("change", (e) => {
        localStorage.setItem("pageSize", e.target.value);
        loadExpenses(1);
      });

      // ✅ Initial Load
      loadExpenses(currentPage);
    
  </script>
</body>
</html>
